# Docker æ„å»ºä¼˜åŒ–æŒ‡å—

## ğŸš€ æ„å»ºé€Ÿåº¦ä¼˜åŒ–æ€»ç»“

åŸå§‹ Dockerfile å­˜åœ¨ä»¥ä¸‹æ€§èƒ½é—®é¢˜ï¼š
1. **ç³»ç»Ÿä¾èµ–å®‰è£…æ…¢** - å®‰è£…äº†å¤§é‡ç¼–è¯‘å·¥å…·
2. **PythonåŒ…ç¼–è¯‘æ…¢** - pandasã€numpyã€matplotlibéœ€è¦æœ¬åœ°ç¼–è¯‘
3. **ç¼ºä¹å¤šé˜¶æ®µæ„å»º** - ç¼–è¯‘å·¥å…·è¿›å…¥äº†è¿è¡Œæ—¶é•œåƒ
4. **Dockerå±‚ç¼“å­˜ä¸ä¼˜åŒ–** - æ–‡ä»¶å¤åˆ¶é¡ºåºå¯¼è‡´ç¼“å­˜å¤±æ•ˆ
5. **æ„å»ºä¸Šä¸‹æ–‡è¿‡å¤§** - åŒ…å«äº†ä¸å¿…è¦çš„æ–‡ä»¶

## ğŸ“ ä¼˜åŒ–ç‰ˆæœ¬è¯´æ˜

### 1. Dockerfile.light (æ¨è)
- **ç‰¹ç‚¹**: ä½¿ç”¨é¢„ç¼–è¯‘wheelsï¼Œé¿å…æœ¬åœ°ç¼–è¯‘
- **ä¼˜åŠ¿**: æ„å»ºé€Ÿåº¦æœ€å¿«ï¼Œé•œåƒè¾ƒå°
- **é€‚ç”¨**: ç”Ÿäº§ç¯å¢ƒã€å¿«é€Ÿéƒ¨ç½²

### 2. Dockerfile.optimized  
- **ç‰¹ç‚¹**: å¤šé˜¶æ®µæ„å»ºï¼Œåˆ†ç¦»ç¼–è¯‘å’Œè¿è¡Œç¯å¢ƒ
- **ä¼˜åŠ¿**: é•œåƒæœ€å°ï¼Œå®‰å…¨æ€§é«˜
- **é€‚ç”¨**: ç”Ÿäº§ç¯å¢ƒã€èµ„æºå—é™ç¯å¢ƒ

### 3. Dockerfile (åŸå§‹)
- **ç‰¹ç‚¹**: åŸå§‹ç‰ˆæœ¬ï¼Œæœ¬åœ°ç¼–è¯‘æ‰€æœ‰åŒ…
- **é€‚ç”¨**: éœ€è¦ç‰¹æ®Šç¼–è¯‘é€‰é¡¹çš„åœºæ™¯

## ğŸ› ï¸ ä½¿ç”¨æ–¹æ³•

### å¿«é€Ÿå¼€å§‹

```bash
# è½»é‡çº§æ„å»ºï¼ˆæ¨èï¼‰
./build_fast.sh -t light -c -r

# ä¼˜åŒ–ç‰ˆæ„å»º
./build_fast.sh -t optimized -c -r

# æ¸…ç†æ—§é•œåƒ
./build_fast.sh --clean
```

### Docker Compose

```bash
# ç”Ÿäº§ç¯å¢ƒ
docker-compose -f docker-compose.optimized.yml up

# è½»é‡çº§ç‰ˆæœ¬
docker-compose -f docker-compose.optimized.yml --profile light up

# å¼€å‘ç¯å¢ƒ
docker-compose -f docker-compose.optimized.yml --profile dev up
```

### æ‰‹åŠ¨æ„å»º

```bash
# å¯ç”¨ BuildKit
export DOCKER_BUILDKIT=1

# è½»é‡çº§æ„å»º
docker build -f Dockerfile.light -t webpre-tooltip:light .

# å¤šé˜¶æ®µæ„å»º
docker build -f Dockerfile.optimized -t webpre-tooltip:optimized .
```

## âš¡ æ€§èƒ½ä¼˜åŒ–æŠ€å·§

### 1. åˆ©ç”¨Dockerç¼“å­˜
```bash
# æ„å»ºæ—¶ä½¿ç”¨ç¼“å­˜
docker build --cache-from webpre-tooltip:light -t webpre-tooltip:light .
```

### 2. ä½¿ç”¨.dockerignore
ç¡®ä¿ `.dockerignore` æ–‡ä»¶å­˜åœ¨ï¼Œå‡å°‘æ„å»ºä¸Šä¸‹æ–‡å¤§å°ã€‚

### 3. å›ºå®šç‰ˆæœ¬å·
ä½¿ç”¨ `requirements.optimized.txt` ä¸­çš„å›ºå®šç‰ˆæœ¬ï¼Œé¿å…ç‰ˆæœ¬è§£ææ—¶é—´ã€‚

### 4. é¢„ç¼–è¯‘wheels
```bash
# å¼ºåˆ¶ä½¿ç”¨é¢„ç¼–è¯‘åŒ…
pip install --only-binary=all -r requirements.txt
```

## ğŸ“Š æ€§èƒ½æµ‹è¯•

è¿è¡Œæ€§èƒ½æµ‹è¯•è„šæœ¬ï¼š
```bash
./test_build_performance.sh
```

é¢„æœŸæ€§èƒ½æå‡ï¼š
- **è½»é‡çº§ç‰ˆæœ¬**: æ¯”åŸå§‹ç‰ˆæœ¬å¿« 50-70%
- **ä¼˜åŒ–ç‰ˆæœ¬**: æ¯”åŸå§‹ç‰ˆæœ¬å¿« 40-60%
- **é•œåƒå¤§å°**: å‡å°‘ 30-50%

## ğŸ”§ é«˜çº§ä¼˜åŒ–

### 1. ä½¿ç”¨å¤šé˜¶æ®µæ„å»ºç¼“å­˜
```dockerfile
# åœ¨æ„å»ºé˜¶æ®µä½¿ç”¨ç¼“å­˜æŒ‚è½½
RUN --mount=type=cache,target=/root/.cache/pip \
    pip install -r requirements.txt
```

### 2. å¹¶è¡Œå®‰è£…
```dockerfile
# å¹¶è¡Œå®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && \
    apt-get install -y --no-install-recommends pkg1 pkg2 pkg3 && \
    rm -rf /var/lib/apt/lists/*
```

### 3. é•œåƒå±‚ä¼˜åŒ–
- åˆå¹¶RUNå‘½ä»¤å‡å°‘å±‚æ•°
- æ¸…ç†å®‰è£…ç¼“å­˜
- åˆ é™¤ä¸å¿…è¦çš„æ–‡ä»¶

## ğŸš¨ æ³¨æ„äº‹é¡¹

1. **ç½‘ç»œç¯å¢ƒ**: ç¡®ä¿ä½¿ç”¨äº†å›½å†…é•œåƒæº
2. **èµ„æºé™åˆ¶**: ä¸ºDockeråˆ†é…è¶³å¤Ÿçš„å†…å­˜å’ŒCPU
3. **ç£ç›˜ç©ºé—´**: å®šæœŸæ¸…ç†Dockeré•œåƒå’Œç¼“å­˜
4. **ç‰ˆæœ¬å…¼å®¹**: å›ºå®šç‰ˆæœ¬å·å¯èƒ½éœ€è¦å®šæœŸæ›´æ–°

## ğŸ“ˆ ç›‘æ§æ„å»ºæ€§èƒ½

```bash
# æŸ¥çœ‹æ„å»ºå†å²
docker history webpre-tooltip:light

# æŸ¥çœ‹é•œåƒå¤§å°
docker images | grep webpre-tooltip

# æ¸…ç†ç³»ç»Ÿ
docker system prune -a
```

## ğŸ”„ æŒç»­ä¼˜åŒ–å»ºè®®

1. **å®šæœŸæ›´æ–°åŸºç¡€é•œåƒ**
2. **ç›‘æ§åŒ…ç‰ˆæœ¬æ›´æ–°**
3. **æµ‹è¯•æ–°çš„ä¼˜åŒ–æŠ€æœ¯**
4. **å…³æ³¨Dockerç‰ˆæœ¬æ›´æ–°**

é€šè¿‡è¿™äº›ä¼˜åŒ–ï¼ŒDockeræ„å»ºæ—¶é—´å¯ä»¥ä»åŸæ¥çš„å‡ åˆ†é’Ÿå‡å°‘åˆ°å‡ åç§’ï¼Œæ˜¾è‘—æå‡å¼€å‘æ•ˆç‡ï¼
